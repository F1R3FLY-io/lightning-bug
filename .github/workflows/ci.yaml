name: CI and Release
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

on:
  push:
    branches: [main]
    tags: [v*]
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  lint-and-test-types:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: latest
          cache: npm
          cache-dependency-path: package-lock.json
          registry-url: 'https://npm.pkg.github.com'

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '23'

      - name: Set up Clojure
        uses: DeLaGuardo/setup-clojure@13.4
        with:
          cli: latest

      - name: Cache clojure dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.deps.clj
            .cpcache
          key: cljdeps-${{ hashFiles('deps.edn') }}
          restore-keys: cljdeps-

      - name: Install dependencies
        run: npm install

      - name: Lint
        run: npm run lint

      - name: Run type tests
        run: npm run test:types

  test-debug:
    timeout-minutes: 10
    needs: [lint-and-test-types]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        browser: [chrome, firefox, edge, opera]
        include:
          - os: macos-latest
            browser: safari
    runs-on: ${{ matrix.os }}
    env:
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: latest
          cache: npm
          cache-dependency-path: package-lock.json
          registry-url: 'https://npm.pkg.github.com'

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '23'

      - name: Set up Clojure
        uses: DeLaGuardo/setup-clojure@13.4
        with:
          cli: latest

      - name: Cache clojure dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.deps.clj
            .cpcache
          key: cljdeps-${{ hashFiles('deps.edn') }}
          restore-keys: cljdeps-

      - name: Install dependencies
        run: npm install

      - name: Install system dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt update
          sudo apt upgrade -y
          sudo apt install -y dirmngr ca-certificates software-properties-common apt-transport-https curl dbus dbus-x11 gsettings-desktop-schemas upower xvfb gnupg wget

      - name: Prepare test
        run: npm run prepare:all

      - name: Install Chocolatey
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

      - name: Install Browser
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $browser = "${{ matrix.browser }}"
          if ($browser -eq "chrome") { choco install googlechrome -y }
          elseif ($browser -eq "firefox") { choco install firefox -y }
          elseif ($browser -eq "edge") { choco install microsoft-edge -y }
          elseif ($browser -eq "opera") { choco install opera -y }

      - name: Install Browser
        if: matrix.os == 'ubuntu-latest'
        run: |
          browser="${{ matrix.browser }}"
          if [ "$browser" = "chrome" ]; then
            wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
            echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
            sudo apt update
            sudo apt install google-chrome-stable -y
          elif [ "$browser" = "firefox" ]; then
            # Remove any existing Snap Firefox (if present)
            sudo snap remove --purge firefox || true
            # Add Mozilla PPA for deb Firefox
            sudo add-apt-repository ppa:mozillateam/ppa -y
            # Pin the deb package to avoid Snap reinstall
            echo '
            Package: *
            Pin: release o=LP-PPA-mozillateam
            Pin-Priority: 1001
            ' | sudo tee /etc/apt/preferences.d/mozilla-firefox
            sudo apt update
            sudo apt install firefox -y
          elif [ "$browser" = "edge" ]; then
            curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
            sudo install -o root -g root -m 644 microsoft.gpg /etc/apt/trusted.gpg.d/
            sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge-dev.list'
            sudo rm microsoft.gpg
            sudo apt update
            sudo apt install microsoft-edge-stable -y
          elif [ "$browser" = "opera" ]; then
            curl -fsSL https://deb.opera.com/archive.key | gpg --dearmor | sudo tee /usr/share/keyrings/opera.gpg > /dev/null
            echo deb [arch=amd64 signed-by=/usr/share/keyrings/opera.gpg] https://deb.opera.com/opera-stable/ stable non-free | sudo tee /etc/apt/sources.list.d/opera.list
            sudo apt update
            sudo apt install opera-stable -y
          fi

      - name: Install Chrome via brew on macOS
        if: matrix.browser == 'chrome' && matrix.os == 'macos-latest'
        run: brew install --cask google-chrome

      - name: Set CHROME_BIN
        if: matrix.browser == 'chrome'
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "CHROME_BIN=C:/Program Files/Google/Chrome/Application/chrome.exe" >> $GITHUB_ENV
          elif [ "$RUNNER_OS" == "macOS" ]; then
            echo "CHROME_BIN=/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" >> $GITHUB_ENV
          else
            echo "CHROME_BIN=/usr/bin/google-chrome-stable" >> $GITHUB_ENV
          fi

      - name: Install Firefox via brew on macOS
        if: matrix.browser == 'firefox' && matrix.os == 'macos-latest'
        run: brew install --cask firefox

      - name: Set FIREFOX_BIN
        if: matrix.browser == 'firefox'
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "FIREFOX_BIN=C:/Program Files/Mozilla Firefox/firefox.exe" >> $GITHUB_ENV
          elif [ "$RUNNER_OS" == "macOS" ]; then
            echo "FIREFOX_BIN=/Applications/Firefox.app/Contents/MacOS/firefox" >> $GITHUB_ENV
          else
            echo "FIREFOX_BIN=/usr/bin/firefox" >> $GITHUB_ENV
          fi

      - name: Install Edge via brew on macOS
        if: matrix.browser == 'edge' && matrix.os == 'macos-latest'
        run: brew install --cask microsoft-edge

      - name: Set EDGE_BIN
        if: matrix.browser == 'edge'
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "EDGE_BIN=C:/Program Files (x86)/Microsoft/Edge/Application/msedge.exe" >> $GITHUB_ENV
          elif [ "$RUNNER_OS" == "macOS" ]; then
            echo "EDGE_BIN=/Applications/Microsoft Edge.app/Contents/MacOS/Microsoft Edge" >> $GITHUB_ENV
          else
            echo "EDGE_BIN=/usr/bin/microsoft-edge-stable" >> $GITHUB_ENV
          fi

      - name: Install Opera via brew on macOS
        if: matrix.browser == 'opera' && matrix.os == 'macos-latest'
        run: brew install --cask opera

      - name: Set OPERA_BIN
        if: matrix.browser == 'opera'
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            echo "OPERA_BIN=/usr/bin/opera" >> $GITHUB_ENV
          elif [ "$RUNNER_OS" == "macOS" ]; then
            echo "OPERA_BIN=/Applications/Opera.app/Contents/MacOS/Opera" >> $GITHUB_ENV
          elif [ "$RUNNER_OS" == "Windows" ]; then
            echo "OPERA_BIN=C:/Program Files/Opera/opera.exe" >> $GITHUB_ENV
          fi

      - name: Start services
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo service dbus start
          sudo service upower start

      - name: Set KARMA_BROWSERS
        run: |
          case "${{ matrix.browser }}" in
            chrome) echo "KARMA_BROWSERS=ChromeHeadlessNoSandbox" >> $GITHUB_ENV ;;
            firefox) echo "KARMA_BROWSERS=FirefoxHeadless" >> $GITHUB_ENV ;;
            edge) echo "KARMA_BROWSERS=EdgeHeadless" >> $GITHUB_ENV ;;
            opera) echo "KARMA_BROWSERS=OperaHeadless" >> $GITHUB_ENV ;;
            safari) echo "KARMA_BROWSERS=Safari" >> $GITHUB_ENV ;;
          esac
        shell: bash

      - name: Run headless tests
        if: matrix.os == 'ubuntu-latest'
        run: dbus-run-session -- xvfb-run --auto-servernum npm run test:debug

      - name: Run headless tests
        if: matrix.os != 'ubuntu-latest'
        run: npm run test:debug

      - name: Build demo (dev)
        if: matrix.browser != 'safari'
        run: npm run build:demo

      - name: Run sanity test (dev)
        if: matrix.os == 'ubuntu-latest' && matrix.browser != 'safari'
        env:
          TEST_BROWSER: ${{ matrix.browser }}
          CHROME_BIN: ${{ env.CHROME_BIN }}
          FIREFOX_BIN: ${{ env.FIREFOX_BIN }}
          EDGE_BIN: ${{ env.EDGE_BIN }}
          OPERA_BIN: ${{ env.OPERA_BIN }}
          SAFARI_BIN: /Applications/Safari.app/Contents/MacOS/Safari
        run: dbus-run-session -- xvfb-run --auto-servernum node scripts/test-demo.js

      - name: Run sanity test (dev)
        if: matrix.os != 'ubuntu-latest' && matrix.browser != 'safari'
        env:
          TEST_BROWSER: ${{ matrix.browser }}
          CHROME_BIN: ${{ env.CHROME_BIN }}
          FIREFOX_BIN: ${{ env.FIREFOX_BIN }}
          EDGE_BIN: ${{ env.EDGE_BIN }}
          OPERA_BIN: ${{ env.OPERA_BIN }}
          SAFARI_BIN: /Applications/Safari.app/Contents/MacOS/Safari
        run: node scripts/test-demo.js

  test-release:
    timeout-minutes: 10
    needs: [lint-and-test-types]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        browser: [chrome, firefox, edge, opera]
        include:
          - os: macos-latest
            browser: safari
    runs-on: ${{ matrix.os }}
    env:
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: latest
          cache: npm
          cache-dependency-path: package-lock.json
          registry-url: 'https://npm.pkg.github.com'

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '23'

      - name: Set up Clojure
        uses: DeLaGuardo/setup-clojure@13.4
        with:
          cli: latest

      - name: Cache clojure dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.deps.clj
            .cpcache
          key: cljdeps-${{ hashFiles('deps.edn') }}
          restore-keys: cljdeps-

      - name: Install dependencies
        run: npm install

      - name: Install system dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt update
          sudo apt upgrade -y
          sudo apt install -y dirmngr ca-certificates software-properties-common apt-transport-https curl dbus dbus-x11 gsettings-desktop-schemas upower xvfb gnupg wget

      - name: Prepare test
        run: npm run prepare:all

      - name: Install Chocolatey
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

      - name: Install Browser
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $browser = "${{ matrix.browser }}"
          if ($browser -eq "chrome") { choco install googlechrome -y }
          elseif ($browser -eq "firefox") { choco install firefox -y }
          elseif ($browser -eq "edge") { choco install microsoft-edge -y }
          elseif ($browser -eq "opera") { choco install opera -y }

      - name: Install Browser
        if: matrix.os == 'ubuntu-latest'
        run: |
          browser="${{ matrix.browser }}"
          if [ "$browser" = "chrome" ]; then
            wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
            echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
            sudo apt update
            sudo apt install google-chrome-stable -y
          elif [ "$browser" = "firefox" ]; then
            # Remove any existing Snap Firefox (if present)
            sudo snap remove --purge firefox || true
            # Add Mozilla PPA for deb Firefox
            sudo add-apt-repository ppa:mozillateam/ppa -y
            # Pin the deb package to avoid Snap reinstall
            echo '
            Package: *
            Pin: release o=LP-PPA-mozillateam
            Pin-Priority: 1001
            ' | sudo tee /etc/apt/preferences.d/mozilla-firefox
            sudo apt update
            sudo apt install firefox -y
          elif [ "$browser" = "edge" ]; then
            curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
            sudo install -o root -g root -m 644 microsoft.gpg /etc/apt/trusted.gpg.d/
            sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge-dev.list'
            sudo rm microsoft.gpg
            sudo apt update
            sudo apt install microsoft-edge-stable -y
          elif [ "$browser" = "opera" ]; then
            curl -fsSL https://deb.opera.com/archive.key | gpg --dearmor | sudo tee /usr/share/keyrings/opera.gpg > /dev/null
            echo deb [arch=amd64 signed-by=/usr/share/keyrings/opera.gpg] https://deb.opera.com/opera-stable/ stable non-free | sudo tee /etc/apt/sources.list.d/opera.list
            sudo apt update
            sudo apt install opera-stable -y
          fi

      - name: Install Chrome via brew on macOS
        if: matrix.browser == 'chrome' && matrix.os == 'macos-latest'
        run: brew install --cask google-chrome

      - name: Set CHROME_BIN
        if: matrix.browser == 'chrome'
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "CHROME_BIN=C:/Program Files/Google/Chrome/Application/chrome.exe" >> $GITHUB_ENV
          elif [ "$RUNNER_OS" == "macOS" ]; then
            echo "CHROME_BIN=/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" >> $GITHUB_ENV
          else
            echo "CHROME_BIN=/usr/bin/google-chrome-stable" >> $GITHUB_ENV
          fi

      - name: Install Firefox via brew on macOS
        if: matrix.browser == 'firefox' && matrix.os == 'macos-latest'
        run: brew install --cask firefox

      - name: Set FIREFOX_BIN
        if: matrix.browser == 'firefox'
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "FIREFOX_BIN=C:/Program Files/Mozilla Firefox/firefox.exe" >> $GITHUB_ENV
          elif [ "$RUNNER_OS" == "macOS" ]; then
            echo "FIREFOX_BIN=/Applications/Firefox.app/Contents/MacOS/firefox" >> $GITHUB_ENV
          else
            echo "FIREFOX_BIN=/usr/bin/firefox" >> $GITHUB_ENV
          fi

      - name: Install Edge via brew on macOS
        if: matrix.browser == 'edge' && matrix.os == 'macos-latest'
        run: brew install --cask microsoft-edge

      - name: Set EDGE_BIN
        if: matrix.browser == 'edge'
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "EDGE_BIN=C:/Program Files (x86)/Microsoft/Edge/Application/msedge.exe" >> $GITHUB_ENV
          elif [ "$RUNNER_OS" == "macOS" ]; then
            echo "EDGE_BIN=/Applications/Microsoft Edge.app/Contents/MacOS/Microsoft Edge" >> $GITHUB_ENV
          else
            echo "EDGE_BIN=/usr/bin/microsoft-edge-stable" >> $GITHUB_ENV
          fi

      - name: Install Opera via brew on macOS
        if: matrix.browser == 'opera' && matrix.os == 'macos-latest'
        run: brew install --cask opera

      - name: Set OPERA_BIN
        if: matrix.browser == 'opera'
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            echo "OPERA_BIN=/usr/bin/opera" >> $GITHUB_ENV
          elif [ "$RUNNER_OS" == "macOS" ]; then
            echo "OPERA_BIN=/Applications/Opera.app/Contents/MacOS/Opera" >> $GITHUB_ENV
          elif [ "$RUNNER_OS" == "Windows" ]; then
            echo "OPERA_BIN=C:/Program Files/Opera/opera.exe" >> $GITHUB_ENV
          fi

      - name: Start services
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo service dbus start
          sudo service upower start

      - name: Set KARMA_BROWSERS
        run: |
          case "${{ matrix.browser }}" in
            chrome) echo "KARMA_BROWSERS=ChromeHeadlessNoSandbox" >> $GITHUB_ENV ;;
            firefox) echo "KARMA_BROWSERS=FirefoxHeadless" >> $GITHUB_ENV ;;
            edge) echo "KARMA_BROWSERS=EdgeHeadless" >> $GITHUB_ENV ;;
            opera) echo "KARMA_BROWSERS=OperaHeadless" >> $GITHUB_ENV ;;
            safari) echo "KARMA_BROWSERS=Safari" >> $GITHUB_ENV ;;
          esac
        shell: bash

      - name: Run headless advanced tests
        if: matrix.os == 'ubuntu-latest'
        run: dbus-run-session -- xvfb-run --auto-servernum npm run test:release

      - name: Run headless advanced tests
        if: matrix.os != 'ubuntu-latest'
        run: npm run test:release

      - name: Build demo (release)
        if: matrix.browser != 'safari'
        env:
          MODE: release
        run: npm run build:demo

      # Quick-and-dirty method for stripping the erroneous `goog=goog||{};`
      # statement from the compiled libs.
      # ----------------------------------------------------------------------
      # TODO: Replace this with a proper fix when possible. I had it fixed but
      # it snuck back in somehow ...
      # ----------------------------------------------------------------------
      - name: Strip goog
        if: matrix.browser != 'safari'
        run: node scripts/strip-goog.js dist/libs/lib.core.js

      - name: Run sanity test (release)
        if: matrix.os == 'ubuntu-latest' && matrix.browser != 'safari'
        env:
          TEST_BROWSER: ${{ matrix.browser }}
          CHROME_BIN: ${{ env.CHROME_BIN }}
          FIREFOX_BIN: ${{ env.FIREFOX_BIN }}
          EDGE_BIN: ${{ env.EDGE_BIN }}
          OPERA_BIN: ${{ env.OPERA_BIN }}
          SAFARI_BIN: /Applications/Safari.app/Contents/MacOS/Safari
        run: dbus-run-session -- xvfb-run --auto-servernum node scripts/test-demo.js

      - name: Run sanity test (release)
        if: matrix.os != 'ubuntu-latest' && matrix.browser != 'safari'
        env:
          TEST_BROWSER: ${{ matrix.browser }}
          CHROME_BIN: ${{ env.CHROME_BIN }}
          FIREFOX_BIN: ${{ env.FIREFOX_BIN }}
          EDGE_BIN: ${{ env.EDGE_BIN }}
          OPERA_BIN: ${{ env.OPERA_BIN }}
          SAFARI_BIN: /Applications/Safari.app/Contents/MacOS/Safari
        run: node scripts/test-demo.js

      - name: Upload libs artifact
        if: matrix.os == 'ubuntu-latest' && matrix.browser == 'chrome'
        uses: actions/upload-artifact@v4
        with:
          name: libs-artifact
          path: |
            dist/**
            types/**
            resources/public/extensions/**
            scripts/postinstall.js

  release:
    timeout-minutes: 10
    needs: [test-debug, test-release]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: latest
          registry-url: 'https://npm.pkg.github.com'

      - name: Download libs artifact
        uses: actions/download-artifact@v4
        with:
          name: libs-artifact
          path: .

      - name: Publish to GitHub Packages
        run: npm publish --access public
