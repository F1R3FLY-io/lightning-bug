<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lightning Bug Demo</title>
  <link href="./node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="css/demo.css">
  <script type="importmap">
    {
      "imports": {
        "@f1r3fly-io/lightning-bug": "./node_modules/@f1r3fly-io/lightning-bug/dist/libs/lib.core.js",
        "@f1r3fly-io/lightning-bug/extensions": "./node_modules/@f1r3fly-io/lightning-bug/dist/libs/ext.lang.rholang.js",
        "@f1r3fly-io/lightning-bug/tree-sitter": "./node_modules/@f1r3fly-io/lightning-bug/dist/libs/embedded.tree-sitter.js",
        "@f1r3fly-io/lightning-bug/extensions/lang/rholang/tree-sitter": "./node_modules/@f1r3fly-io/lightning-bug/dist/libs/embedded.rholang.js",
        "@f1r3fly-io/lightning-bug/extensions/lang/rholang/tree-sitter/queries": "./node_modules/@f1r3fly-io/lightning-bug/dist/libs/embedded.rholang-queries.js",
        "@f1r3fly-io/tree-sitter-rholang-js-with-comments": "./node_modules/@f1r3fly-io/tree-sitter-rholang-js-with-comments/dist/tree-sitter-rholang-js.es.js",
        "react": "https://esm.sh/react@19.0.0-rc-f994737d14-20240522",
        "react-dom": "https://esm.sh/react-dom@19.0.0-rc-f994737d14-20240522",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0-rc-f994737d14-20240522/client",
        "rxjs": "https://esm.sh/rxjs@7.8.2",
        "@codemirror/autocomplete": "./node_modules/@codemirror/autocomplete/dist/index.js",
        "@codemirror/commands": "./node_modules/@codemirror/commands/dist/index.js",
        "@codemirror/language": "./node_modules/@codemirror/language/dist/index.js",
        "@codemirror/lint": "./node_modules/@codemirror/lint/dist/index.js",
        "@codemirror/search": "./node_modules/@codemirror/search/dist/index.js",
        "@codemirror/state": "./node_modules/@codemirror/state/dist/index.js",
        "@codemirror/view": "./node_modules/@codemirror/view/dist/index.js",
        "@lezer/common": "./node_modules/@lezer/common/dist/index.js",
        "@lezer/highlight": "./node_modules/@lezer/highlight/dist/index.js",
        "style-mod": "./node_modules/style-mod/src/style-mod.js",
        "w3c-keyname": "./node_modules/w3c-keyname/index.js",
        "crelt": "./node_modules/crelt/index.js",
        "@marijn/find-cluster-break": "./node_modules/@marijn/find-cluster-break/src/index.js",
        "web-tree-sitter": "./node_modules/web-tree-sitter/tree-sitter.js"
      }
    }
  </script>
  <script>
    var global = globalThis;  // Or window.global = window; for older browsers
  </script>
  <script type="module">
    import * as React from 'react';
    import { createRoot } from 'react-dom/client';
    import { Editor } from '@f1r3fly-io/lightning-bug';
    import { RholangExtension } from '@f1r3fly-io/lightning-bug/extensions';
    import { treeSitterWasmUrl } from '@f1r3fly-io/lightning-bug/tree-sitter';
    import { highlightsQueryUrl, indentsQueryUrl } from '@f1r3fly-io/lightning-bug/extensions/lang/rholang/tree-sitter/queries';
    import { wasm } from '@f1r3fly-io/tree-sitter-rholang-js-with-comments';
    (async () => {
      try {
        const root = createRoot(document.getElementById('app'));
        const editorRef = React.createRef();
        window.editorRef = editorRef; // Expose for testing
        root.render(React.createElement(Editor, {
          ref: editorRef,
          treeSitterWasm: treeSitterWasmUrl,
          languages: {"rholang": {
            ...RholangExtension,
            grammarWasm: wasm,
            highlightsQueryPath: highlightsQueryUrl,
            indentsQueryPath: indentsQueryUrl,
          }}
        }));
        console.log("Rendered");
        const waitForReady = (ref) => new Promise(resolve => {
          const check = () => {
            console.log("Checking ready...");
            if (ref.current && ref.current.isReady()) {
              console.log("Is ready");
              resolve();
            } else {
              setTimeout(check, 100);
            }
          };
          check();
        });
        console.log("Await waitForReady");
        await waitForReady(editorRef);
        console.log("Editor ready");
        const events = editorRef.current.getEvents();
        const waitForEvent = (events, type, matcher = () => true) => new Promise(resolve => {
          const sub = events.subscribe(event => {
            console.log('Event received:', event.type);
            if (event.type === type && matcher(event.data)) {
              sub.unsubscribe();
              resolve(event.data);
            }
          });
        });
        editorRef.current.openDocument(
          "demo.rho",
          "new x in { x!(\"Hello\") | Nil }",
          "rholang"
        );
        await waitForEvent(events, "document-open", data => data.uri === "demo.rho" && data.activated);
        console.log("Document opened and activated");
        console.log('State:', editorRef.current.getState());
        editorRef.current.setCursor({ line: 1, column: 3 });
        console.log('Cursor:', editorRef.current.getCursor());
        editorRef.current.setSelection({ line: 1, column: 1 }, { line: 1, column: 6 });
        console.log('Selection:', editorRef.current.getSelection());
        console.log('Text:', editorRef.current.getText());
        console.log('File Path:', editorRef.current.getFilePath());
        console.log('File URI:', editorRef.current.getFileUri());
        console.log('Diagnostics:', editorRef.current.getDiagnostics());
        console.log('Symbols:', editorRef.current.getSymbols());
        console.log('Search Term:', editorRef.current.getSearchTerm());
        console.log('Log Level:', editorRef.current.getLogLevel());
        editorRef.current.setLogLevel('debug');
        console.log('New Log Level:', editorRef.current.getLogLevel());
        const subscription = editorRef.current.getEvents().subscribe(event => {
          console.log('Event:', event.type, event.data);
        });
      } catch (e) {
        console.error("Script error:", e.name, e.message, e.stack, JSON.stringify(e, Object.getOwnPropertyNames(e)));
      }
    })();
  </script>
</head>
<body>
  <div id="app" style="height: 100vh;"></div>
</body>
</html>
