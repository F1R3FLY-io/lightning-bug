<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lightning Bug Demo</title>
  <link href="./node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="css/demo.css">
  <script type="importmap">
    {
      "imports": {
        "@f1r3fly-io/lightning-bug": "./node_modules/@f1r3fly-io/lightning-bug/dist/libs/lib.core.js",
        "@f1r3fly-io/lightning-bug/extensions": "./node_modules/@f1r3fly-io/lightning-bug/dist/libs/ext.lang.rholang.js",
        "react": "https://esm.sh/react@19.0.0-rc-f994737d14-20240522",
        "react-dom": "https://esm.sh/react-dom@19.0.0-rc-f994737d14-20240522",
        "react-dom/client": "https://esm.sh/react-dom@19.0.0-rc-f994737d14-20240522/client",
        "rxjs": "https://esm.sh/rxjs@7.8.2",
        "@codemirror/autocomplete": "https://esm.sh/@codemirror/autocomplete@6.18.6",
        "@codemirror/commands": "https://esm.sh/@codemirror/commands@6.8.1",
        "@codemirror/language": "https://esm.sh/@codemirror/language@6.11.2",
        "@codemirror/state": "https://esm.sh/@codemirror/state@6.5.2",
        "@codemirror/view": "https://esm.sh/@codemirror/view@6.38.1",
        "web-tree-sitter": "./node_modules/web-tree-sitter/tree-sitter.js"
      }
    }
  </script>
  <script>
    var global = globalThis;  // Or window.global = window; for older browsers
  </script>
  <script type="module">
    (async () => {
      // Patch goog BEFORE imports
      globalThis.goog = globalThis.goog || {};  // Ensure goog exists
      globalThis.goog.provide = globalThis.goog.constructNamespace_ || function(name) { /* noop or log */ };
      globalThis.goog.require = (globalThis.goog.module && globalThis.goog.module.get) || globalThis.goog.require || function(name) { /* noop */ };

      const React = await import('react');
      const { createRoot } = await import('react-dom/client');
      const { Editor } = await import('@f1r3fly-io/lightning-bug');
      const { RholangExtension } = await import('@f1r3fly-io/lightning-bug/extensions');
      const { defaultKeymap } = await import('@codemirror/commands');  // Real import example
      const { keymap } = await import('@codemirror/view');  // Import keymap for wrapping
      const customExtensions = [keymap.of(defaultKeymap)];  // Wrap with keymap.of
      const root = createRoot(document.getElementById('app'));
      const editorRef = React.createRef();
      root.render(React.createElement(Editor, {
        ref: editorRef,
        languages: {"rholang": RholangExtension},
        extraExtensions: customExtensions
      }));
      const interval = setInterval(() => {
        if (editorRef.current && editorRef.current.isReady()) {
          clearInterval(interval);
          const subscription = editorRef.current.getEvents().subscribe(event => {
            console.log('Event:', event.type, event.data);
          });
          editorRef.current.openDocument(
            "demo.rho",
            "new x in { x!(\"Hello\") | Nil }",
            "rholang"
          );
          console.log('Text:', editorRef.current.getText());
          console.log('File path:', editorRef.current.getFilePath());
          console.log('File URI:', editorRef.current.getFileUri());
          editorRef.current.openDocument("second.rho", "Nil");
          editorRef.current.setActiveDocument("demo.rho");
          editorRef.current.renameDocument("renamed.rho", "second.rho");
          editorRef.current.setCursor({ line: 1, column: 3 });
          console.log('Cursor after set:', editorRef.current.getCursor());
          editorRef.current.setSelection({ line: 1, column: 1 }, { line: 1, column: 6 });
          console.log('Selection after set:', editorRef.current.getSelection());
          editorRef.current.highlightRange({ line: 1, column: 1 }, { line: 1, column: 6 });
          editorRef.current.clearHighlight();
          editorRef.current.centerOnRange({ line: 1, column: 1 }, { line: 1, column: 6 });
          editorRef.current.setText("setText text");
          console.log('Text after setText:', editorRef.current.getText());
          editorRef.current.setText("setText updated");
          console.log('Text after setText:', editorRef.current.getText());
          editorRef.current.saveDocument();
          console.log('State:', editorRef.current.getState());
          editorRef.current.closeDocument();
          subscription.unsubscribe();
        }
      }, 100);
    })();
  </script>
</head>
<body>
  <div id="app" style="height: 100vh;"></div>
</body>
</html>
